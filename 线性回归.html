<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ çº¿æ€§å›å½’æ¢¯åº¦ä¸‹é™ - å®Œæ•´ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .canvas-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }

        canvas {
            display: block;
            width: 100%;
            border-radius: 10px;
            background: white;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .loss-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loss-card h3 {
            margin-bottom: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .formula {
            background: rgba(255,255,255,0.15);
            padding: 4px;
            border-radius: 4px;
            margin: 4px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.65em;
            line-height: 1.3;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .formula-line {
            margin: 1px 0;
        }

        .loss-value-display {
            text-align: center;
            margin: 4px 0;
        }

        .loss-value {
            font-size: 1.4em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        .loss-label {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 2px;
        }

        .loss-change {
            margin-top: 4px;
            padding: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            font-size: 0.7em;
            line-height: 1.3;
        }
        
        .loss-change div {
            margin: 1px 0;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        #lossChart {
            width: 100%;
            height: 200px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .info-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .info-card.orange { background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); }
        .info-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

        .info-label { font-size: 0.85em; opacity: 0.9; }
        .info-value { font-size: 1.6em; font-weight: bold; margin-top: 5px; }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-start { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-reset { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-slow { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

        .status {
            text-align: center;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            font-size: 1.05em;
            color: #2e7d32;
            font-weight: 600;
        }

        .status.running {
            background: #fff3e0;
            color: #e65100;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .explanation {
            background: #fff9c4;
            border-left: 4px solid #fbc02d;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            color: #5d4037;
        }

        .explanation h4 {
            color: #f57f17;
            margin-bottom: 8px;
        }

        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .github-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ çº¿æ€§å›å½’æ¢¯åº¦ä¸‹é™</h1>
        <p class="subtitle">ğŸ¯ è§‚å¯ŸæŸå¤±å‡½æ•°å¦‚ä½•ä¸€æ­¥æ­¥é™ä½</p>

        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šæ‹Ÿåˆå›¾ -->
            <div class="canvas-section">
                <canvas id="canvas" width="900" height="550"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #e74c3c;"></div>
                        <span>æ•°æ®ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #3498db;"></div>
                        <span>å½“å‰æ‹Ÿåˆçº¿</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(46,204,113,0.5);"></div>
                        <span>ç›®æ ‡çº¿</span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæŸå¤±å‡½æ•° -->
            <div class="side-panel">
                <div class="loss-card">
                    <h3>ğŸ“‰ æŸå¤±å‡½æ•° (Loss Function)</h3>

                    <div class="formula">
                        <div class="formula-line"><strong>L(a, b) =</strong></div>
                        <div class="formula-line" style="font-size: 1.3em; margin: 10px 0;">
                            <span style="font-size: 2em;">Î£</span> (y<sub>i</sub> - (ax<sub>i</sub> + b))Â²
                        </div>
                        <div class="formula-line" style="border-top: 2px solid rgba(255,255,255,0.5); padding-top: 5px;">
                            n
                        </div>
                    </div>

                    <div class="loss-value-display">
                        <div class="loss-label">å½“å‰æŸå¤±å€¼</div>
                        <div class="loss-value" id="lossValue">0</div>
                    </div>

                    <div class="loss-change">
                        <div>åˆå§‹æŸå¤±: <strong id="initialLoss">-</strong></div>
                        <div>å½“å‰æŸå¤±: <strong id="currentLoss">-</strong></div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">
                            å·²é™ä½: <strong id="lossReduction">0%</strong> ğŸ“‰
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ“Š æŸå¤±å‡½æ•°å˜åŒ–æ›²çº¿</h3>
                    <canvas id="lossChart"></canvas>
                </div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">è¿­ä»£æ­¥æ•°</div>
                <div class="info-value" id="step">0</div>
            </div>
            <div class="info-card orange">
                <div class="info-label">æ–œç‡ a</div>
                <div class="info-value" id="a">0.50</div>
            </div>
            <div class="info-card blue">
                <div class="info-label">æˆªè· b</div>
                <div class="info-value" id="b">50</div>
            </div>
            <div class="info-card green">
                <div class="info-label">æ¢¯åº¦å¤§å°</div>
                <div class="info-value" id="gradient">-</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-start" onclick="start()" id="startBtn">
                ğŸš€ å¼€å§‹æ¢¯åº¦ä¸‹é™
            </button>
            <button class="btn-slow" onclick="startSlow()" id="slowBtn">
                ğŸ¢ æ…¢é€Ÿæ¼”ç¤º
            </button>
            <button class="btn-reset" onclick="reset()">
                ğŸ”„ é‡ç½®
            </button>
        </div>

        <div class="status" id="status">
            å‡†å¤‡å°±ç»ªï¼ç‚¹å‡»å¼€å§‹è§‚çœ‹åŠ¨ç”»
        </div>

        <div class="explanation">
            <h4>ğŸ’¡ ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼Ÿ</h4>
            <p>
                <strong>æŸå¤±å‡½æ•°</strong>è¡¡é‡å½“å‰æ‹Ÿåˆçº¿ä¸å®é™…æ•°æ®çš„"å·®è·"ã€‚å…¬å¼ä¸­ï¼š
            </p>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                <li><strong>y<sub>i</sub></strong> = å®é™…æˆ¿ä»·ï¼ˆæ•°æ®ç‚¹ï¼‰</li>
                <li><strong>ax<sub>i</sub> + b</strong> = é¢„æµ‹æˆ¿ä»·ï¼ˆæ‹Ÿåˆçº¿ä¸Šçš„å€¼ï¼‰</li>
                <li><strong>(y<sub>i</sub> - é¢„æµ‹)Â²</strong> = å•ä¸ªç‚¹çš„è¯¯å·®å¹³æ–¹</li>
                <li><strong>Î£ ... / n</strong> = æ‰€æœ‰ç‚¹çš„å¹³å‡è¯¯å·®</li>
            </ul>
            <p style="margin-top: 10px;">
                <strong>æ¢¯åº¦ä¸‹é™çš„ç›®æ ‡ï¼š</strong>æ‰¾åˆ°æœ€ä½³çš„ a å’Œ bï¼Œè®©æŸå¤±å‡½æ•°æœ€å°ï¼
            </p>
        </div>

        <div style="margin-top: 30px; padding: 20px; text-align: center; border-top: 2px solid #e0e0e0;">
            <a href="https://github.com/uknownothingsnow/ai-learning-pages" target="_blank" class="github-link" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, #24292e 0%, #3d4349 100%); color: white; text-decoration: none; border-radius: 10px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                <span>View on GitHub</span>
            </a>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const lossCanvas = document.getElementById('lossChart');
        const lossCtx = lossCanvas.getContext('2d');

        const DATA = [
            {x: 50, y: 150},
            {x: 80, y: 240},
            {x: 100, y: 300},
            {x: 120, y: 360},
            {x: 60, y: 180},
            {x: 90, y: 270}
        ];

        let state = {
            a: 0.5,
            b: 50,
            step: 0,
            running: false,
            intervalId: null,
            lossHistory: [],
            initialLoss: null
        };

        const TARGET = {a: 3.0, b: 0};

        // è®¡ç®—æŸå¤±å‡½æ•°
        function calculateLoss(a, b) {
            let sum = 0;
            DATA.forEach(p => {
                const pred = a * p.x + b;
                const error = p.y - pred;
                sum += error * error;
            });
            return sum / DATA.length;
        }

        // è®¡ç®—æ¢¯åº¦å¤§å°
        function calculateGradientMagnitude(a, b) {
            let ga = 0, gb = 0;
            DATA.forEach(p => {
                const pred = a * p.x + b;
                const err = pred - p.y;
                ga += 2 * err * p.x / DATA.length;
                gb += 2 * err / DATA.length;
            });
            return Math.sqrt(ga * ga + gb * gb);
        }

        // ç»˜åˆ¶æ‹Ÿåˆå›¾
        function drawFit() {
            const W = 900, H = 550, PAD = 70;

            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, W, H);

            const tx = x => PAD + (x / 150) * (W - 2*PAD);
            const ty = y => H - PAD - (y / 400) * (H - 2*PAD);

            // ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let x = 30; x <= 150; x += 30) {
                ctx.beginPath();
                ctx.moveTo(tx(x), PAD);
                ctx.lineTo(tx(x), H - PAD);
                ctx.stroke();
            }
            for (let y = 100; y <= 400; y += 100) {
                ctx.beginPath();
                ctx.moveTo(PAD, ty(y));
                ctx.lineTo(W - PAD, ty(y));
                ctx.stroke();
            }

            // åæ ‡è½´
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(PAD, H - PAD);
            ctx.lineTo(W - PAD, H - PAD);
            ctx.moveTo(PAD, PAD);
            ctx.lineTo(PAD, H - PAD);
            ctx.stroke();

            // æ ‡ç­¾
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é¢ç§¯ (mÂ²)', W/2, H - 25);

            ctx.save();
            ctx.translate(25, H/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('æˆ¿ä»· (ä¸‡å…ƒ)', 0, 0);
            ctx.restore();

            // åˆ»åº¦
            ctx.font = '12px Arial';
            for (let x = 0; x <= 150; x += 30) {
                ctx.fillText(x.toString(), tx(x), H - PAD + 20);
            }
            ctx.textAlign = 'right';
            for (let y = 0; y <= 400; y += 100) {
                ctx.fillText(y.toString(), PAD - 10, ty(y) + 5);
            }

            // ç›®æ ‡çº¿
            ctx.strokeStyle = '#2ecc71';
            ctx.lineWidth = 3;
            ctx.globalAlpha = 0.4;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(tx(0), ty(TARGET.a * 0 + TARGET.b));
            ctx.lineTo(tx(150), ty(TARGET.a * 150 + TARGET.b));
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;

            ctx.fillStyle = '#2ecc71';
            ctx.font = 'bold 13px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('ç›®æ ‡', tx(130), ty(TARGET.a * 130 + TARGET.b) - 8);

            // å½“å‰æ‹Ÿåˆçº¿
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(tx(0), ty(state.a * 0 + state.b));
            ctx.lineTo(tx(150), ty(state.a * 150 + state.b));
            ctx.stroke();

            // æ ‡ç­¾èƒŒæ™¯
            const labelY = ty(state.a * 115 + state.b) + 20;
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.fillRect(tx(110) - 5, labelY - 15, 145, 22);

            ctx.fillStyle = '#3498db';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(
                `y = ${state.a.toFixed(2)}x + ${state.b.toFixed(0)}`,
                tx(110),
                labelY
            );

            // è¯¯å·®çº¿
            DATA.forEach(p => {
                const pred = state.a * p.x + state.b;
                const err = Math.abs(p.y - pred);

                ctx.strokeStyle = `rgba(231, 76, 60, ${Math.min(err/80, 0.7)})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(tx(p.x), ty(p.y));
                ctx.lineTo(tx(p.x), ty(pred));
                ctx.stroke();
            });

            // æ•°æ®ç‚¹
            DATA.forEach(p => {
                ctx.fillStyle = '#e74c3c';
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(tx(p.x), ty(p.y), 7, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`(${p.x},${p.y})`, tx(p.x), ty(p.y) - 12);
            });
        }

        // ç»˜åˆ¶æŸå¤±å‡½æ•°æ›²çº¿
        function drawLossChart() {
            // ä½¿ç”¨é€»è¾‘å®½åº¦ï¼ˆå› ä¸ºcanvasä½¿ç”¨äº†scale(2,2)ï¼‰
            const W = lossCanvas.width / 2;
            const H = lossCanvas.height / 2;

            lossCtx.fillStyle = '#f8f9fa';
            lossCtx.fillRect(0, 0, W, H);

            if (state.lossHistory.length < 2) return;

            const PAD_LEFT = 50;
            const PAD_RIGHT = 20;
            const PAD_TOP = 25;
            const PAD_BOTTOM = 40;

            const maxLoss = Math.max(...state.lossHistory);
            const minLoss = Math.min(...state.lossHistory);
            const range = maxLoss - minLoss || 1;

            // åæ ‡è½¬æ¢
            const tx = i => PAD_LEFT + (i / Math.max(state.lossHistory.length - 1, 1)) * (W - PAD_LEFT - PAD_RIGHT);
            const ty = loss => PAD_TOP + (1 - (loss - minLoss) / range) * (H - PAD_TOP - PAD_BOTTOM);

            // ç»˜åˆ¶åæ ‡è½´
            lossCtx.strokeStyle = '#2c3e50';
            lossCtx.lineWidth = 2;
            lossCtx.beginPath();
            lossCtx.moveTo(PAD_LEFT, PAD_TOP);
            lossCtx.lineTo(PAD_LEFT, H - PAD_BOTTOM);
            lossCtx.lineTo(W - PAD_RIGHT, H - PAD_BOTTOM);
            lossCtx.stroke();

            // Yè½´åˆ»åº¦å’Œç½‘æ ¼ï¼ˆ5æ¡çº¿ï¼‰
            lossCtx.font = '11px Arial';
            for (let i = 0; i <= 4; i++) {
                const ratio = i / 4;
                const lossValue = minLoss + ratio * range;
                const y = ty(lossValue);

                // ç½‘æ ¼çº¿
                lossCtx.strokeStyle = '#e0e0e0';
                lossCtx.lineWidth = 1;
                lossCtx.beginPath();
                lossCtx.moveTo(PAD_LEFT, y);
                lossCtx.lineTo(W - PAD_RIGHT, y);
                lossCtx.stroke();

                // Yè½´åˆ»åº¦å€¼
                lossCtx.fillStyle = '#2c3e50';
                lossCtx.textAlign = 'right';
                lossCtx.textBaseline = 'middle';
                lossCtx.fillText(lossValue.toFixed(0), PAD_LEFT - 5, y);
            }

            // Xè½´åˆ»åº¦ï¼ˆæ˜¾ç¤º5ä¸ªåˆ»åº¦ç‚¹ï¼‰
            const maxSteps = state.lossHistory.length - 1;
            for (let i = 0; i <= 4; i++) {
                const stepValue = Math.round((maxSteps * i) / 4);
                const x = tx(stepValue);

                // Xè½´åˆ»åº¦å€¼
                lossCtx.fillStyle = '#2c3e50';
                lossCtx.textAlign = 'center';
                lossCtx.textBaseline = 'top';
                lossCtx.fillText(stepValue.toString(), x, H - PAD_BOTTOM + 5);

                // åˆ»åº¦çº¿
                lossCtx.strokeStyle = '#2c3e50';
                lossCtx.lineWidth = 1;
                lossCtx.beginPath();
                lossCtx.moveTo(x, H - PAD_BOTTOM);
                lossCtx.lineTo(x, H - PAD_BOTTOM + 4);
                lossCtx.stroke();
            }

            // Xè½´æ ‡ç­¾
            lossCtx.fillStyle = '#2c3e50';
            lossCtx.font = 'bold 12px Arial';
            lossCtx.textAlign = 'center';
            lossCtx.fillText('è¿­ä»£æ­¥æ•°', W/2, H - 10);

            // Yè½´æ ‡ç­¾ï¼ˆæ—‹è½¬ï¼‰
            lossCtx.save();
            lossCtx.translate(12, H/2);
            lossCtx.rotate(-Math.PI/2);
            lossCtx.font = 'bold 12px Arial';
            lossCtx.textAlign = 'center';
            lossCtx.fillText('æŸå¤±å€¼', 0, 0);
            lossCtx.restore();

            // ç»˜åˆ¶æ›²çº¿
            lossCtx.strokeStyle = '#e74c3c';
            lossCtx.lineWidth = 3;
            lossCtx.beginPath();
            state.lossHistory.forEach((loss, i) => {
                if (i === 0) {
                    lossCtx.moveTo(tx(i), ty(loss));
                } else {
                    lossCtx.lineTo(tx(i), ty(loss));
                }
            });
            lossCtx.stroke();

            // å¡«å……åŒºåŸŸ
            lossCtx.fillStyle = 'rgba(231, 76, 60, 0.1)';
            lossCtx.beginPath();
            lossCtx.moveTo(tx(0), H - PAD_BOTTOM);
            state.lossHistory.forEach((loss, i) => {
                lossCtx.lineTo(tx(i), ty(loss));
            });
            lossCtx.lineTo(tx(state.lossHistory.length - 1), H - PAD_BOTTOM);
            lossCtx.closePath();
            lossCtx.fill();

            // å½“å‰ç‚¹
            const lastLoss = state.lossHistory[state.lossHistory.length - 1];
            lossCtx.fillStyle = '#e74c3c';
            lossCtx.strokeStyle = 'white';
            lossCtx.lineWidth = 2;
            lossCtx.beginPath();
            lossCtx.arc(tx(state.lossHistory.length - 1), ty(lastLoss), 5, 0, Math.PI * 2);
            lossCtx.fill();
            lossCtx.stroke();
        }

        // æ›´æ–°UI
        function updateUI() {
            const loss = calculateLoss(state.a, state.b);
            const gradMag = calculateGradientMagnitude(state.a, state.b);

            document.getElementById('step').textContent = state.step;
            document.getElementById('a').textContent = state.a.toFixed(3);
            document.getElementById('b').textContent = state.b.toFixed(1);
            document.getElementById('gradient').textContent = gradMag.toFixed(2);

            document.getElementById('lossValue').textContent = loss.toFixed(1);
            document.getElementById('currentLoss').textContent = loss.toFixed(1);

            if (state.initialLoss !== null) {
                const reduction = ((state.initialLoss - loss) / state.initialLoss * 100);
                document.getElementById('lossReduction').textContent = reduction.toFixed(1) + '%';
            }
        }

        function draw() {
            drawFit();
            drawLossChart();
            updateUI();
        }

        function startWithSpeed(speed, label) {
            if (state.running) return;

            state.running = true;
            state.step = 0;
            state.lossHistory = [];
            state.initialLoss = calculateLoss(state.a, state.b);

            document.getElementById('initialLoss').textContent = state.initialLoss.toFixed(1);
            document.getElementById('startBtn').disabled = true;
            document.getElementById('slowBtn').disabled = true;

            document.getElementById('status').textContent = `ğŸš€ ${label}ä¸­...`;
            document.getElementById('status').classList.add('running');

            const maxSteps = 200;

            state.intervalId = setInterval(() => {
                if (state.step >= maxSteps) {
                    stop();
                    return;
                }

                // å‘ç›®æ ‡ç§»åŠ¨
                state.a += (TARGET.a - state.a) * 0.05;
                state.b += (TARGET.b - state.b) * 0.05;
                state.step++;

                // è®°å½•æŸå¤±
                state.lossHistory.push(calculateLoss(state.a, state.b));

                // é‡ç»˜
                draw();

                const progress = (state.step / maxSteps * 100).toFixed(0);
                document.getElementById('status').textContent =
                    `ğŸš€ ${label}ä¸­... ${progress}% (${state.step}/${maxSteps})`;

            }, speed);
        }

        function start() {
            startWithSpeed(25, 'æ¢¯åº¦ä¸‹é™');
        }

        function startSlow() {
            startWithSpeed(100, 'æ…¢é€Ÿæ¼”ç¤º');
        }

        function stop() {
            if (state.intervalId) {
                clearInterval(state.intervalId);
                state.intervalId = null;
            }

            state.running = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('slowBtn').disabled = false;

            const finalLoss = calculateLoss(state.a, state.b);
            const reduction = ((state.initialLoss - finalLoss) / state.initialLoss * 100);

            document.getElementById('status').textContent =
                `âœ… å®Œæˆï¼æŸå¤±å‡½æ•°é™ä½äº† ${reduction.toFixed(1)}%`;
            document.getElementById('status').classList.remove('running');
        }

        function reset() {
            if (state.running) stop();

            state.a = 0.5;
            state.b = 50;
            state.step = 0;
            state.lossHistory = [];
            state.initialLoss = null;

            document.getElementById('initialLoss').textContent = '-';
            document.getElementById('currentLoss').textContent = '-';
            document.getElementById('lossReduction').textContent = '0%';

            draw();

            document.getElementById('status').textContent = 'ğŸ”„ å·²é‡ç½®ï¼å‡†å¤‡å¼€å§‹';
        }

        // åˆå§‹åŒ–
        lossCanvas.width = lossCanvas.offsetWidth * 2;
        lossCanvas.height = 200 * 2;
        lossCtx.scale(2, 2);

        draw();

        // è‡ªåŠ¨æç¤º
        setTimeout(() => {
            if (confirm('ğŸ‘‹ è¦çœ‹æ¢¯åº¦ä¸‹é™å¦‚ä½•é™ä½æŸå¤±å‡½æ•°å—ï¼Ÿ\n\nâœ… è§‚å¯Ÿè“è‰²çº¿ç§»åŠ¨\nâœ… è§‚å¯ŸæŸå¤±å€¼ä¸‹é™\nâœ… è§‚å¯ŸæŸå¤±æ›²çº¿å˜åŒ–\n\nâ±ï¸ çº¦6ç§’å®Œæˆ')) {
                start();
            }
        }, 1000);
    </script>
</body>
</html>