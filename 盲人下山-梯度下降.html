<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§— ç›²äººä¸‹å±± - æ¢¯åº¦ä¸‹é™ç®—æ³•å¯è§†åŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .canvas-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }

        canvas {
            display: block;
            width: 100%;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .value-display {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            margin-left: 10px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-reset {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .info-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .info-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .story-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .story-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .story-section p {
            color: #856404;
            line-height: 1.6;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .status-bar {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
            color: #2e7d32;
        }

        .status-bar.running {
            background: #fff3e0;
            color: #e65100;
            animation: pulse 1.5s infinite;
        }

        .speed-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .speed-btn {
            padding: 10px;
            font-size: 0.95em;
            background: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .speed-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .speed-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§— ç›²äººä¸‹å±± - æ¢¯åº¦ä¸‹é™ç®—æ³•</h1>
        <p class="subtitle">ä¸€ä¸ªç›´è§‚çš„æœºå™¨å­¦ä¹ ä¼˜åŒ–ç®—æ³•å¯è§†åŒ–æ¼”ç¤º</p>

        <div class="story-section">
            <h3>ğŸ“– æ•…äº‹èƒŒæ™¯</h3>
            <p>
                æƒ³è±¡ä¸€ä½ç›²äººç«™åœ¨å±±ä¸Šï¼Œä»–æƒ³ä¸‹åˆ°å±±è°·ï¼ˆæœ€ä½ç‚¹ï¼‰ï¼Œä½†ä»–çœ‹ä¸è§å‘¨å›´çš„åœ°å½¢ã€‚
                ä»–èƒ½åšçš„åªæœ‰ï¼š<strong>æ„Ÿå—è„šä¸‹çš„å¡åº¦</strong>ï¼Œç„¶åæ²¿ç€<strong>æœ€é™¡çš„ä¸‹å¡æ–¹å‘</strong>èµ°ä¸€å°æ­¥ã€‚
                é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œæœ€ç»ˆä»–ä¼šåˆ°è¾¾å±±è°·ã€‚è¿™å°±æ˜¯<strong>æ¢¯åº¦ä¸‹é™ç®—æ³•</strong>çš„æ ¸å¿ƒæ€æƒ³ï¼
            </p>
        </div>

        <div class="main-content">
            <div class="canvas-section">
                <canvas id="canvas" width="1000" height="750"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: linear-gradient(to bottom, #8B4513, #90EE90);"></div>
                        <span>3Då±±åœ°åœ°å½¢ï¼ˆæŸå¤±å‡½æ•°ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ff6b6b; box-shadow: 0 0 10px rgba(255,107,107,0.6);"></div>
                        <span>ğŸ§‘ ç›²äººå½“å‰ä½ç½®</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #4ecdc4;"></div>
                        <span>è¡Œèµ°è·¯å¾„ï¼ˆä¼˜åŒ–è½¨è¿¹ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ffd700;"></div>
                        <span>â­ å±±è°·ï¼ˆå…¨å±€æœ€å°å€¼ï¼‰</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">
                    ğŸ’¡ æç¤ºï¼šç‚¹å‡»3Dåœ°å½¢çš„ä»»æ„ä½ç½®è®¾ç½®èµ·ç‚¹
                </div>
            </div>

            <div class="control-panel">
                <div class="control-group">
                    <label>
                        ğŸ¬ åŠ¨ç”»é€Ÿåº¦æ¨¡å¼
                        <span class="value-display" id="speedModeValue">ğŸš¶ æ­£å¸¸</span>
                    </label>
                    <div class="speed-buttons">
                        <button class="speed-btn" data-mode="slow" onclick="setSpeedMode('slow')">
                            ğŸŒ æ…¢é€Ÿ
                        </button>
                        <button class="speed-btn active" data-mode="normal" onclick="setSpeedMode('normal')">
                            ğŸš¶ æ­£å¸¸
                        </button>
                        <button class="speed-btn" data-mode="fast" onclick="setSpeedMode('fast')">
                            ğŸƒ å¿«é€Ÿ
                        </button>
                    </div>
                    <small style="color: #7f8c8d;" id="speedDesc">æ ‡å‡†é€Ÿåº¦</small>
                </div>

                <div class="control-group">
                    <label>
                        âš¡ å­¦ä¹ ç‡ï¼ˆæ­¥é•¿ï¼‰
                        <span class="value-display" id="lrValue">0.008</span>
                    </label>
                    <input type="range" id="learningRate" min="0.002" max="0.05" step="0.002" value="0.008">
                    <small style="color: #7f8c8d;">æ­¥é•¿è¶Šå¤§ï¼Œä¸‹å±±è¶Šå¿«ï¼Œä½†å¯èƒ½è¶Šè¿‡å±±è°·</small>
                </div>

                <div class="control-group">
                    <label>
                        ğŸ¯ åœ°å½¢å¤æ‚åº¦
                        <span class="value-display" id="terrainValue">ä¸­ç­‰</span>
                    </label>
                    <input type="range" id="terrain" min="1" max="3" step="1" value="2">
                    <small style="color: #7f8c8d;">å¤æ‚åº¦è¶Šé«˜ï¼Œå±€éƒ¨æœ€å°å€¼è¶Šå¤š</small>
                </div>

                <div class="button-group">
                    <button class="btn-start" onclick="start()" id="startBtn">
                        ğŸš€ å¼€å§‹ä¸‹å±±
                    </button>
                    <button class="btn-stop" onclick="stop()" id="stopBtn" disabled>
                        â¸ï¸ æš‚åœ
                    </button>
                </div>

                <button class="btn-reset" onclick="reset()" style="width: 100%;">
                    ğŸ”„ é‡æ–°é€‰æ‹©èµ·ç‚¹
                </button>

                <div class="info-cards">
                    <div class="info-card">
                        <div class="info-label">å½“å‰é«˜åº¦</div>
                        <div class="info-value" id="height">0.00</div>
                    </div>
                    <div class="info-card green">
                        <div class="info-label">è¡Œèµ°æ­¥æ•°</div>
                        <div class="info-value" id="steps">0</div>
                    </div>
                    <div class="info-card orange">
                        <div class="info-label">æ¢¯åº¦å¤§å°</div>
                        <div class="info-value" id="gradient">0.00</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">è·ç¦»å±±è°·</div>
                        <div class="info-value" id="distance">-</div>
                    </div>
                </div>

                <div class="status-bar" id="status">
                    ç‚¹å‡»ç”»å¸ƒé€‰æ‹©ç›²äººçš„èµ·å§‹ä½ç½®
                </div>
            </div>
        </div>

        <div class="story-section" style="background: #e3f2fd; border-left-color: #2196f3;">
            <h3 style="color: #1565c0;">ğŸ’¡ ç®—æ³•åŸç†</h3>
            <p style="color: #1565c0;">
                <strong>1. è®¡ç®—æ¢¯åº¦ï¼š</strong>ç›²äººæ„Ÿå—è„šä¸‹çš„å¡åº¦æ–¹å‘<br>
                <strong>2. åå‘ç§»åŠ¨ï¼š</strong>æ²¿ç€ä¸‹å¡æ–¹å‘èµ°ä¸€å°æ­¥ï¼ˆå­¦ä¹ ç‡å†³å®šæ­¥é•¿ï¼‰<br>
                <strong>3. åŠ¨é‡ä¼˜åŒ–ï¼š</strong>ä¿æŒä¹‹å‰çš„ç§»åŠ¨æ–¹å‘ï¼Œé¿å…éœ‡è¡<br>
                <strong>4. æ¢¯åº¦è£å‰ªï¼š</strong>é˜²æ­¢æ­¥é•¿è¿‡å¤§å¯¼è‡´è¶Šè¿‡å±±è°·<br>
                <strong>5. æ”¶æ•›æ£€æµ‹ï¼š</strong>å½“æ¢¯åº¦æ¥è¿‘0æ—¶åœæ­¢
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // çŠ¶æ€å˜é‡
        let state = {
            x: null,
            y: null,
            steps: 0,
            running: false,
            intervalId: null,
            path: [],
            learningRate: 0.008,  // è¿›ä¸€æ­¥é™ä½é»˜è®¤å­¦ä¹ ç‡
            baseLearningRate: 0.008,  // åŸºç¡€å­¦ä¹ ç‡
            terrain: 2,
            startSet: false,
            velocityX: 0,  // æ·»åŠ åŠ¨é‡
            velocityY: 0,
            momentum: 0.8,  // æé«˜åŠ¨é‡ç³»æ•°ï¼Œä½¿ç§»åŠ¨æ›´å¹³æ»‘
            speedMode: 'normal',  // é€Ÿåº¦æ¨¡å¼ï¼šslow/normal/fast
            animationInterval: 30  // åŠ¨ç”»é—´éš”(ms)
        };

        // é€Ÿåº¦æ¨¡å¼é…ç½®
        const speedModes = {
            slow: {
                lrMultiplier: 0.3,    // å­¦ä¹ ç‡ä¹˜æ•°
                interval: 60,         // åŠ¨ç”»é—´éš”(ms)
                label: 'ğŸŒ æ…¢é€Ÿ',
                description: 'å­¦ä¹ ç‡Ã—0.3ï¼Œé€‚åˆè§‚å¯Ÿç»†èŠ‚'
            },
            normal: {
                lrMultiplier: 1.0,
                interval: 30,
                label: 'ğŸš¶ æ­£å¸¸',
                description: 'æ ‡å‡†é€Ÿåº¦'
            },
            fast: {
                lrMultiplier: 2.5,
                interval: 20,
                label: 'ğŸƒ å¿«é€Ÿ',
                description: 'å­¦ä¹ ç‡Ã—2.5ï¼Œå¿«é€Ÿæ”¶æ•›'
            }
        };

        // åœ°å½¢å‚æ•°ï¼ˆå½±å“æŸå¤±å‡½æ•°çš„å½¢çŠ¶ï¼‰
        let terrainParams = {
            1: { scale: 2.0, valleys: 1, noise: 0.0 },   // ç®€å•ï¼šçº¯äºŒæ¬¡å‡½æ•°
            2: { scale: 2.0, valleys: 2, noise: 0.15 },  // ä¸­ç­‰
            3: { scale: 2.0, valleys: 3, noise: 0.25 }   // å¤æ‚
        };

        // æŸå¤±å‡½æ•°ï¼šæ¨¡æ‹Ÿå±±åœ°åœ°å½¢ï¼ˆç¡®ä¿æœ€å°å€¼åœ¨(0.5, 0.5)ï¼‰
        function lossFunction(x, y) {
            const params = terrainParams[state.terrain];
            const scale = params.scale;
            const valleys = params.valleys;
            const noise = params.noise;

            // ä¸»è¦çš„äºŒæ¬¡å‡½æ•°ï¼ˆæŠ›ç‰©é¢ï¼‰ - ä¸­å¿ƒåœ¨(0.5, 0.5)ï¼Œè¿™æ˜¯å…¨å±€æœ€å°å€¼
            let loss = scale * (Math.pow(x - 0.5, 2) + Math.pow(y - 0.5, 2));

            // æ·»åŠ å¹³æ»‘çš„å±€éƒ¨èµ·ä¼ï¼ˆä½†ä¸æ”¹å˜å…¨å±€æœ€å°å€¼ä½ç½®ï¼‰
            if (valleys >= 2) {
                // ä½¿ç”¨ä»¥(0.5,0.5)ä¸ºä¸­å¿ƒçš„å¯¹ç§°æ³¢åŠ¨
                const dx = x - 0.5;
                const dy = y - 0.5;
                const r = Math.sqrt(dx * dx + dy * dy);
                loss += noise * Math.sin(8 * Math.PI * r) * r;
            }
            if (valleys >= 3) {
                // æ·»åŠ ä¸€äº›å°çš„ä¸å¯¹ç§°æ€§
                loss += noise * 0.3 * Math.sin(4 * Math.PI * x) * Math.cos(4 * Math.PI * y);
            }

            return loss;
        }

        // è®¡ç®—æ¢¯åº¦ï¼ˆåå¯¼æ•°ï¼‰
        function computeGradient(x, y) {
            const h = 0.001;  // å¾ˆå°çš„æ­¥é•¿ç”¨äºæ•°å€¼å¾®åˆ†
            const dx = (lossFunction(x + h, y) - lossFunction(x - h, y)) / (2 * h);
            const dy = (lossFunction(x, y + h) - lossFunction(x, y - h)) / (2 * h);
            return { dx, dy };
        }

        // 3Dç­‰è·æŠ•å½±è½¬æ¢
        function to3D(x, y, z) {
            // ç­‰è·æŠ•å½±å‚æ•° - å¢å¤§åœ°å½¢
            const scale = 450;  // å¢å¤§ç¼©æ”¾æ¯”ä¾‹
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2 + 100;  // è°ƒæ•´Yåç§»
            const heightScale = 180;  // å¢å¤§é«˜åº¦ç¼©æ”¾

            // ç­‰è·æŠ•å½±å…¬å¼
            // ä¸­å¿ƒç‚¹è°ƒæ•´ï¼šå°†0.5,0.5ä½œä¸ºä¸­å¿ƒ
            const centerX = x - 0.5;
            const centerY = y - 0.5;

            const isoX = (centerX - centerY) * scale + offsetX;
            const isoY = (centerX + centerY) * scale * 0.5 - z * heightScale + offsetY;

            return { x: isoX, y: isoY };
        }

        // ç®€å•çš„å™ªå£°å‡½æ•°ï¼ˆç”¨äºçº¹ç†ç”Ÿæˆï¼‰
        function noise(x, y) {
            const n = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;
            return n - Math.floor(n);
        }

        // ç”Ÿæˆå±±çŸ³çº¹ç†é¢œè‰²
        function getRockTexture(x, y, baseZ, shading) {
            // æ ¹æ®é«˜åº¦å†³å®šåŸºç¡€é¢œè‰²
            const heightRatio = Math.max(0, Math.min(1, 1 - baseZ * 1.5));

            // æ·»åŠ å™ªå£°çº¹ç†
            const noiseVal = noise(x * 100, y * 100) * 0.3 +
                           noise(x * 50, y * 50) * 0.2 +
                           noise(x * 200, y * 200) * 0.15;

            let r, g, b;

            if (heightRatio < 0.3) {
                // é«˜å±±ï¼šæ·±ç°è‰²å²©çŸ³
                r = 80 + noiseVal * 40;
                g = 70 + noiseVal * 35;
                b = 60 + noiseVal * 30;
            } else if (heightRatio < 0.6) {
                // ä¸­ç­‰ï¼šæ£•è‰²å²©çŸ³
                r = 120 + noiseVal * 50;
                g = 90 + noiseVal * 40;
                b = 60 + noiseVal * 30;
            } else if (heightRatio < 0.85) {
                // ä½å¤„ï¼šåœŸé»„è‰²
                r = 160 + noiseVal * 40;
                g = 140 + noiseVal * 35;
                b = 90 + noiseVal * 30;
            } else {
                // å±±è°·ï¼šç»¿è‰²è‰åœ°
                r = 100 + noiseVal * 30;
                g = 160 + noiseVal * 40;
                b = 80 + noiseVal * 25;
            }

            // åº”ç”¨å…‰ç…§
            r *= shading;
            g *= shading;
            b *= shading;

            return `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
        }

        // ç»˜åˆ¶3Dåœ°å½¢
        function drawTerrain() {
            // å…ˆç»˜åˆ¶èƒŒæ™¯ï¼ˆå¤©ç©ºæ¸å˜ï¼‰
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGradient.addColorStop(0, '#87CEEB');  // å¤©è“è‰²
            skyGradient.addColorStop(0.5, '#B0E0E6');  // ç²‰è“è‰²
            skyGradient.addColorStop(1, '#F0F8FF');  // è¿‘ç™½è‰²
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ç½‘æ ¼åˆ†è¾¨ç‡ï¼ˆå¢åŠ ä»¥è·å¾—æ›´å¤šç»†èŠ‚ï¼‰
            const gridSize = 30;
            const step = 1 / gridSize;

            // å­˜å‚¨æ‰€æœ‰é¢ç‰‡ç”¨äºZæ’åº
            const faces = [];

            // ç”Ÿæˆåœ°å½¢ç½‘æ ¼é¢ç‰‡
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const x0 = i * step;
                    const y0 = j * step;
                    const x1 = (i + 1) * step;
                    const y1 = (j + 1) * step;

                    // å››ä¸ªé¡¶ç‚¹çš„é«˜åº¦
                    const z00 = lossFunction(x0, y0);
                    const z10 = lossFunction(x1, y0);
                    const z01 = lossFunction(x0, y1);
                    const z11 = lossFunction(x1, y1);

                    // è®¡ç®—é¢ç‰‡ä¸­å¿ƒç”¨äºæ’åº
                    const centerX = (x0 + x1) / 2;
                    const centerY = (y0 + y1) / 2;
                    const centerZ = (z00 + z10 + z01 + z11) / 4;

                    // è½¬æ¢ä¸º3Dåæ ‡
                    const p00 = to3D(x0, y0, z00);
                    const p10 = to3D(x1, y0, z10);
                    const p01 = to3D(x0, y1, z01);
                    const p11 = to3D(x1, y1, z11);

                    // è®¡ç®—æ³•å‘é‡å’Œå…‰ç…§
                    const normalX = (z10 - z00 + z11 - z01) / 2;
                    const normalY = (z01 - z00 + z11 - z10) / 2;
                    const normalMag = Math.sqrt(normalX * normalX + normalY * normalY + 0.01);

                    // å…‰ç…§æ–¹å‘ï¼ˆä»å³ä¸Šæ–¹ç…§å°„ï¼‰
                    const lightX = 0.5;
                    const lightY = 0.5;
                    const lightZ = 1.0;
                    const lightDot = (-normalX * lightX - normalY * lightY + 1.0 * lightZ) /
                                    (normalMag * Math.sqrt(lightX * lightX + lightY * lightY + lightZ * lightZ));

                    // ç¯å¢ƒå…‰ + æ¼«åå°„
                    const ambient = 0.5;
                    const diffuse = 0.5;
                    const shading = ambient + diffuse * Math.max(0, lightDot);

                    // ä½¿ç”¨çº¹ç†é¢œè‰²
                    const textureColor = getRockTexture(centerX, centerY, centerZ, shading);

                    faces.push({
                        vertices: [p00, p10, p11, p01],
                        color: textureColor,
                        depth: centerY + centerX,  // ç”¨äºZæ’åº
                        centerZ: centerZ,
                        shading: shading
                    });
                }
            }

            // Zæ’åºï¼ˆç”»å®¶ç®—æ³•ï¼‰
            faces.sort((a, b) => a.depth - b.depth);

            // ç»˜åˆ¶æ‰€æœ‰é¢ç‰‡
            faces.forEach(face => {
                ctx.fillStyle = face.color;

                // ç½‘æ ¼çº¿é¢œè‰²ï¼šé«˜å¤„æ›´æ·±ï¼Œä½å¤„æ›´æµ…
                const gridAlpha = 0.15 + face.shading * 0.15;
                ctx.strokeStyle = `rgba(60, 60, 60, ${gridAlpha})`;
                ctx.lineWidth = 0.8;

                ctx.beginPath();
                ctx.moveTo(face.vertices[0].x, face.vertices[0].y);
                for (let i = 1; i < face.vertices.length; i++) {
                    ctx.lineTo(face.vertices[i].x, face.vertices[i].y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                // åœ¨é«˜å¤„æ·»åŠ é«˜å…‰æ•ˆæœ
                if (face.centerZ < 0.1 && face.shading > 0.8) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${0.1 * face.shading})`;
                    ctx.fill();
                }
            });

            // ç»˜åˆ¶å±±è°·æ˜Ÿæ˜Ÿï¼ˆ3Dä½ç½®ï¼‰
            const valleyZ = lossFunction(0.5, 0.5);
            const valley3D = to3D(0.5, 0.5, valleyZ);

            // æ˜Ÿæ˜Ÿå¤–å‘å…‰åœˆ
            const glowGradient = ctx.createRadialGradient(valley3D.x, valley3D.y, 0, valley3D.x, valley3D.y, 35);
            glowGradient.addColorStop(0, 'rgba(255, 215, 0, 0.4)');
            glowGradient.addColorStop(0.5, 'rgba(255, 215, 0, 0.2)');
            glowGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
            ctx.fillStyle = glowGradient;
            ctx.beginPath();
            ctx.arc(valley3D.x, valley3D.y, 35, 0, Math.PI * 2);
            ctx.fill();

            // æ˜Ÿæ˜Ÿå‘å…‰æ•ˆæœ
            ctx.shadowColor = 'rgba(255, 215, 0, 0.9)';
            ctx.shadowBlur = 25;

            // æ˜Ÿæ˜Ÿåº•åº§
            ctx.fillStyle = '#ffd700';
            ctx.strokeStyle = '#ff8c00';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(valley3D.x, valley3D.y, 22, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            ctx.shadowBlur = 0;

            // æ˜Ÿæ˜Ÿå›¾æ ‡
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('â­', valley3D.x, valley3D.y);

            // æ·»åŠ æ ‡ç­¾èƒŒæ™¯
            const labelY = valley3D.y + 45;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(valley3D.x - 80, labelY - 15, 160, 28);

            // æ·»åŠ æ ‡ç­¾
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('ğŸ”ï¸ å±±è°·ï¼ˆå…¨å±€æœ€ä¼˜è§£ï¼‰', valley3D.x, labelY);
        }

        // ç»˜åˆ¶è·¯å¾„ï¼ˆ3Dï¼‰
        function drawPath() {
            if (state.path.length < 2) return;

            // ç»˜åˆ¶è·¯å¾„çº¿
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 4;
            ctx.setLineDash([]);
            ctx.shadowColor = 'rgba(78, 205, 196, 0.5)';
            ctx.shadowBlur = 10;

            ctx.beginPath();
            for (let i = 0; i < state.path.length; i++) {
                const point = state.path[i];
                const z = lossFunction(point.x, point.y);
                const pos3D = to3D(point.x, point.y, z);

                if (i === 0) {
                    ctx.moveTo(pos3D.x, pos3D.y);
                } else {
                    ctx.lineTo(pos3D.x, pos3D.y);
                }
            }
            ctx.stroke();
            ctx.shadowBlur = 0;

            // ç»˜åˆ¶è·¯å¾„ç‚¹
            state.path.forEach((point, i) => {
                const z = lossFunction(point.x, point.y);
                const pos3D = to3D(point.x, point.y, z);
                const alpha = 0.3 + (i / state.path.length) * 0.7;

                ctx.fillStyle = `rgba(78, 205, 196, ${alpha})`;
                ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(pos3D.x, pos3D.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            });
        }

        // ç»˜åˆ¶ç›²äººï¼ˆ3Dï¼‰
        function drawPerson() {
            if (state.x === null || state.y === null) return;

            const z = lossFunction(state.x, state.y);
            const pos3D = to3D(state.x, state.y, z);

            // ç›²äººçš„é˜´å½±ï¼ˆæŠ•å°„åˆ°åœ°é¢ï¼‰
            const shadowZ = lossFunction(state.x, state.y) - 0.1;
            const shadowPos = to3D(state.x, state.y, shadowZ);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(shadowPos.x, shadowPos.y + 15, 18, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            // ç›²äººèº«ä½“ï¼ˆå‘å…‰æ•ˆæœï¼‰
            ctx.shadowColor = 'rgba(255, 107, 107, 0.6)';
            ctx.shadowBlur = 15;
            ctx.fillStyle = '#ff6b6b';
            ctx.strokeStyle = '#c92a2a';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(pos3D.x, pos3D.y, 18, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.shadowBlur = 0;

            // ç›²äººå›¾æ ‡
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ§‘', pos3D.x, pos3D.y);

            // æ¢¯åº¦æ–¹å‘ç®­å¤´ï¼ˆ3Dï¼‰
            if (state.running) {
                const grad = computeGradient(state.x, state.y);
                const gradMag = Math.sqrt(grad.dx ** 2 + grad.dy ** 2);

                if (gradMag > 0.001) {
                    // è®¡ç®—ç®­å¤´ç»ˆç‚¹ï¼ˆæ²¿æ¢¯åº¦åæ–¹å‘ï¼‰
                    const arrowStep = 0.05;
                    const arrowEndX = state.x - arrowStep * grad.dx / gradMag;
                    const arrowEndY = state.y - arrowStep * grad.dy / gradMag;
                    const arrowEndZ = lossFunction(arrowEndX, arrowEndY);
                    const arrowEnd3D = to3D(arrowEndX, arrowEndY, arrowEndZ);

                    // ç»˜åˆ¶ç®­å¤´
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([8, 4]);
                    ctx.beginPath();
                    ctx.moveTo(pos3D.x, pos3D.y);
                    ctx.lineTo(arrowEnd3D.x, arrowEnd3D.y);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // ç®­å¤´å¤´éƒ¨
                    const angle = Math.atan2(arrowEnd3D.y - pos3D.y, arrowEnd3D.x - pos3D.x);
                    const headLen = 12;
                    ctx.beginPath();
                    ctx.moveTo(arrowEnd3D.x, arrowEnd3D.y);
                    ctx.lineTo(
                        arrowEnd3D.x - headLen * Math.cos(angle - Math.PI / 6),
                        arrowEnd3D.y - headLen * Math.sin(angle - Math.PI / 6)
                    );
                    ctx.moveTo(arrowEnd3D.x, arrowEnd3D.y);
                    ctx.lineTo(
                        arrowEnd3D.x - headLen * Math.cos(angle + Math.PI / 6),
                        arrowEnd3D.y - headLen * Math.sin(angle + Math.PI / 6)
                    );
                    ctx.stroke();
                }
            }

            // æ˜¾ç¤ºå½“å‰é«˜åº¦æ ‡ç­¾
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 13px Arial';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            const heightText = `é«˜åº¦: ${z.toFixed(3)}`;
            ctx.strokeText(heightText, pos3D.x, pos3D.y - 35);
            ctx.fillText(heightText, pos3D.x, pos3D.y - 35);
        }

        // ç»˜åˆ¶æ‰€æœ‰å†…å®¹
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawTerrain();
            drawPath();
            drawPerson();
        }

        // æ›´æ–°UI
        function updateUI() {
            if (state.x !== null && state.y !== null) {
                const loss = lossFunction(state.x, state.y);
                const grad = computeGradient(state.x, state.y);
                const gradMag = Math.sqrt(grad.dx ** 2 + grad.dy ** 2);
                const distToValley = Math.sqrt((state.x - 0.5) ** 2 + (state.y - 0.5) ** 2);

                document.getElementById('height').textContent = loss.toFixed(4);
                document.getElementById('steps').textContent = state.steps;
                document.getElementById('gradient').textContent = gradMag.toFixed(4);
                document.getElementById('distance').textContent = (distToValley * 100).toFixed(1) + '%';
            }
        }

        // æ¢¯åº¦ä¸‹é™è¿­ä»£ï¼ˆå¸¦åŠ¨é‡ä¼˜åŒ–ï¼‰
        function gradientDescentStep() {
            const grad = computeGradient(state.x, state.y);
            const gradMag = Math.sqrt(grad.dx ** 2 + grad.dy ** 2);

            // è®¡ç®—åˆ°å±±è°·çš„è·ç¦»
            const distToValley = Math.sqrt(Math.pow(state.x - 0.5, 2) + Math.pow(state.y - 0.5, 2));

            // æ”¶æ•›æ¡ä»¶ï¼šæ¢¯åº¦å¾ˆå°æˆ–è€…éå¸¸æ¥è¿‘å±±è°·
            if (gradMag < 0.005 || distToValley < 0.01) {
                stop();
                setStatus('ğŸ‰ åˆ°è¾¾å±±è°·ï¼ä¼˜åŒ–å®Œæˆï¼', false);
                return;
            }

            // æ¢¯åº¦è£å‰ªï¼Œé˜²æ­¢è¿‡å¤§çš„æ›´æ–°
            const maxGrad = 3.0;
            let clippedGradX = grad.dx;
            let clippedGradY = grad.dy;
            if (gradMag > maxGrad) {
                clippedGradX = grad.dx / gradMag * maxGrad;
                clippedGradY = grad.dy / gradMag * maxGrad;
            }

            // æ ¹æ®é€Ÿåº¦æ¨¡å¼è°ƒæ•´å®é™…å­¦ä¹ ç‡
            const effectiveLR = state.baseLearningRate * speedModes[state.speedMode].lrMultiplier;

            // ä½¿ç”¨åŠ¨é‡æ›´æ–°ï¼ˆmomentumä¼˜åŒ–ï¼‰
            state.velocityX = state.momentum * state.velocityX - effectiveLR * clippedGradX;
            state.velocityY = state.momentum * state.velocityY - effectiveLR * clippedGradY;

            // æ›´æ–°ä½ç½®
            const oldLoss = lossFunction(state.x, state.y);
            const oldX = state.x;
            const oldY = state.y;

            state.x += state.velocityX;
            state.y += state.velocityY;

            // è¾¹ç•Œæ£€æŸ¥
            state.x = Math.max(0.05, Math.min(0.95, state.x));
            state.y = Math.max(0.05, Math.min(0.95, state.y));

            // æ£€æŸ¥æ˜¯å¦çœŸçš„åœ¨ä¸‹é™
            const newLoss = lossFunction(state.x, state.y);
            if (newLoss > oldLoss && state.steps > 5) {
                // å›é€€å¹¶å‡å°é€Ÿåº¦
                state.x = oldX;
                state.y = oldY;
                state.velocityX *= 0.3;
                state.velocityY *= 0.3;
            }

            // è®°å½•è·¯å¾„
            state.path.push({ x: state.x, y: state.y });
            state.steps++;

            // é™åˆ¶è·¯å¾„é•¿åº¦
            if (state.path.length > 300) {
                state.path.shift();
            }

            draw();
            updateUI();
        }

        // å¼€å§‹ä¸‹å±±
        function start() {
            if (!state.startSet) {
                alert('è¯·å…ˆåœ¨ç”»å¸ƒä¸Šç‚¹å‡»é€‰æ‹©ç›²äººçš„èµ·å§‹ä½ç½®ï¼');
                return;
            }

            if (state.running) return;

            state.running = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            const modeLabel = speedModes[state.speedMode].label;
            setStatus(`${modeLabel} ç›²äººæ­£åœ¨ä¸‹å±±...`, true);

            // æ ¹æ®é€Ÿåº¦æ¨¡å¼ä½¿ç”¨ä¸åŒçš„åŠ¨ç”»é—´éš”
            const interval = speedModes[state.speedMode].interval;

            state.intervalId = setInterval(() => {
                gradientDescentStep();

                // æœ€å¤§æ­¥æ•°é™åˆ¶
                if (state.steps > 1500) {
                    stop();
                    setStatus('âš ï¸ è¾¾åˆ°æœ€å¤§æ­¥æ•°é™åˆ¶ï¼Œå°è¯•å¢åŠ å­¦ä¹ ç‡æˆ–åˆ‡æ¢åˆ°å¿«é€Ÿæ¨¡å¼', false);
                }
            }, interval);
        }

        // åœæ­¢
        function stop() {
            if (state.intervalId) {
                clearInterval(state.intervalId);
                state.intervalId = null;
            }

            state.running = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            if (state.steps > 0) {
                setStatus('â¸ï¸ å·²æš‚åœã€‚å¯ä»¥ç»§ç»­æˆ–é‡ç½®', false);
            }
        }

        // é‡ç½®
        function reset() {
            stop();
            state.x = null;
            state.y = null;
            state.steps = 0;
            state.path = [];
            state.startSet = false;
            state.velocityX = 0;  // é‡ç½®åŠ¨é‡
            state.velocityY = 0;

            draw();
            updateUI();
            setStatus('ç‚¹å‡»ç”»å¸ƒé€‰æ‹©ç›²äººçš„èµ·å§‹ä½ç½®', false);
        }

        // è®¾ç½®çŠ¶æ€æ¶ˆæ¯
        function setStatus(msg, running) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = running ? 'status-bar running' : 'status-bar';
        }

        // ç”»å¸ƒç‚¹å‡»äº‹ä»¶ï¼ˆéœ€è¦å°†å±å¹•åæ ‡è½¬æ¢å›3Dä¸–ç•Œåæ ‡ï¼‰
        canvas.addEventListener('click', (e) => {
            if (state.running) return;

            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            // ç®€åŒ–ï¼šç›´æ¥æ˜ å°„åˆ°ç½‘æ ¼
            // åœ¨å®é™…3Dä¸­éœ€è¦åå‘æŠ•å½±ï¼Œè¿™é‡Œä½¿ç”¨è¿‘ä¼¼æ–¹æ³•
            let minDist = Infinity;
            let bestX = 0.5;
            let bestY = 0.5;

            // æœç´¢æœ€è¿‘çš„ç½‘æ ¼ç‚¹
            for (let i = 0; i <= 20; i++) {
                for (let j = 0; j <= 20; j++) {
                    const testX = i / 20;
                    const testY = j / 20;
                    const testZ = lossFunction(testX, testY);
                    const pos3D = to3D(testX, testY, testZ);

                    const dist = Math.sqrt(
                        Math.pow(pos3D.x - clickX, 2) +
                        Math.pow(pos3D.y - clickY, 2)
                    );

                    if (dist < minDist) {
                        minDist = dist;
                        bestX = testX;
                        bestY = testY;
                    }
                }
            }

            state.x = bestX;
            state.y = bestY;
            state.steps = 0;
            state.path = [{ x: bestX, y: bestY }];
            state.startSet = true;

            draw();
            updateUI();
            setStatus('âœ… èµ·ç‚¹å·²è®¾ç½®ï¼ç‚¹å‡»"å¼€å§‹ä¸‹å±±"', false);
        });

        // è®¾ç½®é€Ÿåº¦æ¨¡å¼
        function setSpeedMode(mode) {
            if (state.running) {
                alert('è¯·å…ˆåœæ­¢å½“å‰åŠ¨ç”»å†åˆ‡æ¢é€Ÿåº¦æ¨¡å¼');
                return;
            }

            state.speedMode = mode;
            const config = speedModes[mode];

            // æ›´æ–°UI
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            document.getElementById('speedModeValue').textContent = config.label;
            document.getElementById('speedDesc').textContent = config.description;

            // æ˜¾ç¤ºå®é™…å­¦ä¹ ç‡
            updateLearningRateDisplay();
        }

        // æ›´æ–°å­¦ä¹ ç‡æ˜¾ç¤º
        function updateLearningRateDisplay() {
            const effectiveLR = state.baseLearningRate * speedModes[state.speedMode].lrMultiplier;
            const display = document.getElementById('lrValue');
            display.textContent = effectiveLR.toFixed(4);
        }

        // å­¦ä¹ ç‡æ»‘å—
        document.getElementById('learningRate').addEventListener('input', (e) => {
            state.baseLearningRate = parseFloat(e.target.value);
            updateLearningRateDisplay();
        });

        // åœ°å½¢æ»‘å—
        document.getElementById('terrain').addEventListener('input', (e) => {
            state.terrain = parseInt(e.target.value);
            const labels = { 1: 'ç®€å•', 2: 'ä¸­ç­‰', 3: 'å¤æ‚' };
            document.getElementById('terrainValue').textContent = labels[state.terrain];

            if (!state.running) {
                draw();
            }
        });

        // åˆå§‹åŒ–
        draw();
        updateUI();
        updateLearningRateDisplay();
    </script>
</body>
</html>
